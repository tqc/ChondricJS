/*! chondric-tools 0.5.0 */

window.console||(window.console={log:function(){},warn:window.alert,error:window.alert});var Chondric=angular.module("chondric",[]);Chondric.allTransitions={},Chondric.sharedUiComponents={},Chondric.registerSharedUiComponent=function(componentOptions,componentCollection){componentCollection=componentCollection||Chondric.sharedUiComponents;var component={};componentOptions.baseComponentId&&($.extend(component,componentCollection[componentOptions.baseComponentId]),component["controller-"+componentOptions.baseComponentId]=component.controller,component.baseController=function(baseComponentId,$scope){component["controller-"+componentOptions.baseComponentId]($scope)}),$.extend(component,componentOptions),componentCollection[component.id]=component},Chondric.App=Chondric.initApp=function(options){function registerController(name,func){app.controllerProvider?(app.controllerProvider.register(name,func),delete controllerPreload[name]):controllerPreload[name]=func}function preloadTemplate(templateUrl){app.module.run(function($templateCache,$http){$http.get(templateUrl,{cache:$templateCache})})}function initData(callback){app.db=settings.getDatabase(),app.db&&app.db.updateDatabase?app.db.updateDatabase(function(){callback()}):callback()}function attachEvents(callback){callback()}function complete(callback){app.debugMode&&$("body").addClass("debugmode"),app.ready=!0,callback()}var app={},controllerPreload={};app.module=angular.module(options.name||"appModule",["chondric"].concat(options.angularModules||[]),function($controllerProvider){app.controllerProvider=$controllerProvider;for(var cn in controllerPreload||{})registerController(cn,controllerPreload[cn])});var allRoutes=app.allRoutes={};app.allTransitions=Chondric.allTransitions,app.createViewTemplate=function(baseView,templateId,templateFile,viewOptions){"string"==typeof templateId?(viewOptions.baseView=baseView,viewOptions.templateId=templateId,viewOptions.templateFile=templateFile):viewOptions=baseView;var page={};viewOptions.initAngular&&(viewOptions.initAngular.call(page),viewOptions.controllers=viewOptions.controllers||page.controllers);var pageController=null;viewOptions.controller&&(pageController=viewOptions.controller);for(var cn in viewOptions.controllers||{})pageController||(pageController=viewOptions.controllers[cn]),registerController(cn,viewOptions.controllers[cn]);if(!pageController)throw new Error("View "+(viewOptions.templateId||viewOptions.route)+" has no controller");var route=viewOptions.route||"/"+viewOptions.templateId+"/$p1/$p2",templateUrl=viewOptions.templateId+".html";viewOptions.templateFolder&&(templateUrl=viewOptions.templateFolder+"/"+templateUrl),allRoutes[route]={isSection:!1,controller:pageController,templateUrl:templateUrl,templateId:viewOptions.templateId},preloadTemplate(templateUrl)},app.createSection=function(viewOptions){var pageController=null;viewOptions.controller&&(pageController=viewOptions.controller);for(var cn in viewOptions.controllers||{})pageController||(pageController=viewOptions.controllers[cn]),registerController(cn,viewOptions.controllers[cn]);var route=viewOptions.route;allRoutes[route]={isSection:!0,controller:pageController}},app.sharedUiComponents={};for(var k in Chondric.sharedUiComponents){var sc=Chondric.sharedUiComponents[k],ac=app.sharedUiComponents[k]={};$.extend(ac,sc),ac.app=app}app.registerSharedUiComponent=function(component){component.app=app,Chondric.registerSharedUiComponent(component,app.sharedUiComponents)},app.controller=function($scope,$location){function loadView(url){if(!url)throw new Error("loadView requires a valid route URL");var matchingRoutes=[],parts=url.split("/");routeLoop:for(var r in allRoutes){for(var rparts=r.split("/"),i=0;i<rparts.length;i++)if(rparts[i]!=parts[i]&&"$"!=rparts[i][0])continue routeLoop;matchingRoutes.push(r)}matchingRoutes.sort(function(a,b){return a.length-b.length});for(var openViews=$scope.openViews,i2=0;i2<matchingRoutes.length;i2++){for(var template=$scope.allRoutes[matchingRoutes[i2]],mrp=matchingRoutes[i2].split("/"),ar="",params={},j=0;j<mrp.length;j++)"$"==mrp[j][0]&&parts[j]&&(params[mrp[j].substr(1)]=decodeURIComponent(parts[j])),parts[j]&&(ar+="/"+parts[j]);if(!template.isSection){var page=openViews[ar];return void(page||(page=openViews[ar]={controller:template.controller,templateUrl:template.templateUrl,templateId:template.templateId,params:params}))}var section=openViews[ar];section||(section=openViews[ar]={controller:template.controller,isSection:!0,params:params,subsections:{}}),openViews=section.subsections}}function viewCleanup(viewCollection,preservedRoutes){for(var k in viewCollection)if(0===k.indexOf("/")){for(var keep=!1,i=0;i<preservedRoutes.length;i++){var r=preservedRoutes[i];if(r&&0===r.indexOf(k)){keep=!0;break}}if(keep)viewCollection[k].subsections&&viewCleanup(viewCollection[k].subsections,preservedRoutes);else{for(var csfrk in app.componentStatesForRoutes)0===csfrk.indexOf(k)&&delete app.componentStatesForRoutes[csfrk];for(var sfrk in app.scopesForRoutes)0===sfrk.indexOf(k)&&delete app.scopesForRoutes[sfrk];delete viewCollection[k]}}}app.scope=$scope,$scope.app=app,$scope.allRoutes=allRoutes,$scope.route=null,$scope.nextRoute=null,$scope.lastRoute=null,$scope.transition={type:"crossfade",progress:0},$scope.openViews={},$scope.sharedUiComponents=app.sharedUiComponents,$scope.showModal=function(name,lastTap){$scope[name]=lastTap},$scope.hideModal=function(name){$scope[name]=null},$scope.getSharedUiComponentState=app.getSharedUiComponentState=function(routeScope,componentId){app.scopesForRoutes[routeScope.rk]=routeScope;var component=app.sharedUiComponents[componentId];if(!component)throw new Error("Shared UI Component "+componentId+" not found");var csfr=app.componentStatesForRoutes[routeScope.rk]=app.componentStatesForRoutes[routeScope.rk]||{},cs=csfr[componentId]=csfr[componentId]||{route:routeScope.rk,active:!1,available:!1,data:{}};return cs},$scope.setSharedUiComponentState=app.setSharedUiComponentState=function(routeScope,componentId,active,available,data){var cs=app.getSharedUiComponentState(routeScope,componentId);(active===!0||active===!1)&&(cs.active=active),(available===!0||available===!1)&&(cs.available=available),void 0!==data&&(cs.data=data);var uc=routeScope.usedComponents,uci=uc.asArray.indexOf("uses-"+componentId);if(available&&0>uci?(uc.asArray.push("uses-"+componentId),uc.asString=uc.asArray.join(" ")):!available&&uci>=0&&(uc.asArray.splice(uci,1),uc.asString=uc.asArray.join(" ")),$scope.route==routeScope.rk){var component=app.sharedUiComponents[componentId];component.setState(component,routeScope.rk,cs.active,cs.available,cs.data)}},app.scopesForRoutes={},app.componentStatesForRoutes={},$scope.changePage=app.changePage=function(p,transition){var r;if(p instanceof Array){r="";for(var i=0;i<p.length;i++)r+="/"+p[i]}else r=p;if(!r||r.indexOf("/")<0)throw new Error("changePage syntax has changed - the first parameter is a route url or an array of route url segments instead of an id");$scope.route!=r&&($scope.lastRoute==r&&($scope.lastRoute=null),$scope.transition.type=transition||"crossfade",$scope.noTransition=!0,loadView(r),$scope.nextRoute=r,$scope.transition.progress=0,$scope.transition.from=$scope.route,$scope.transition.to=$scope.nextRoute,window.setTimeout(function(){$scope.noTransition=!1,$scope.route=r,$scope.transition.progress=1,$scope.$apply()},100))},$scope.updateSwipe=function(swipeState,swipeNav,pageScope){if(swipeState){for(var k in app.sharedUiComponents){var component=app.sharedUiComponents[k];component.updateSwipe&&component.updateSwipe(component,swipeState)}if(swipeNav)for(var p in swipeState)if(swipeState[p]&&swipeNav[p]){if(swipeNav[p].route)loadView(swipeNav[p].route),$scope.nextRoute=swipeNav[p].route,$scope.transition.from=$scope.route,$scope.transition.to=$scope.nextRoute,$scope.transition.type=swipeNav[p].transition,$scope.transition.progress=swipeState[p];else if(swipeNav[p].panel){var showModal=pageScope.$eval("showModal");showModal(swipeNav[p].panel,{progress:swipeState[p],transition:swipeNav[p].transition})}$scope.$apply()}}},$scope.endSwipe=function(swipeState,swipeNav,pageScope){if(swipeState){for(var k in app.sharedUiComponents){var component=app.sharedUiComponents[k];component.endSwipe&&component.endSwipe(component,swipeState)}if(swipeNav)for(var p in swipeState)if(swipeState[p]&&swipeNav[p]){if(swipeNav[p].route)swipeState[p]>.4?(loadView(swipeNav[p].route),$scope.transition.progress=1,$scope.lastRoute=$scope.route,$scope.route=swipeNav[p].route):$scope.transition.progress=0;else if(swipeNav[p].panel)if(swipeState[p]>.1){var showModal=pageScope.$eval("showModal");showModal(swipeNav[p].panel,{progress:1,transition:swipeNav[p].transition})}else{var hideModal=pageScope.$eval("hideModal");hideModal(swipeNav[p].panel)}$scope.$apply()}}},$scope.$watch("transition",function(transition){if(transition&&transition.to){var fromStates=app.componentStatesForRoutes[transition.from]||{},toStates=app.componentStatesForRoutes[transition.to]||{};for(var k in app.sharedUiComponents){var component=app.sharedUiComponents[k],fromState=fromStates[k]||{route:transition.from,active:!1,available:!1,data:{}},toState=toStates[k]||{route:transition.to,active:!1,available:!1,data:{}};component.setStatePartial?component.setStatePartial(component,fromState,toState,transition.progress):transition.progress>.5?component.setState(component,toState.route,toState.active,toState.available,toState.data):component.setState(component,fromState.route,fromState.active,fromState.available,fromState.data)}}},!0),$scope.$watch("route",function(url,oldVal){url&&(document.activeElement&&document.activeElement.blur(),$scope.nextRoute=null,$scope.lastRoute=oldVal,$location.path(url).replace(),loadView(url),viewCleanup($scope.openViews,[$scope.route,$scope.nextRoute,$scope.lastRoute]))}),options.appCtrl&&options.appCtrl($scope)},app.ready=!1,app.autohidesplashscreen=!1,app.Pages={},app.Actions={},app.startTime=(new Date).getTime(),app.Views={},app.ViewTemplates={},app.platform="web",app.isSimulator=!1;var settings={name:"Base App",mightBePhoneGap:!0,loadPageFromHash:!0,scriptGroups:[],angularModules:[],contexts:{},getDatabase:null,loadData:function(loadedctx,callback){callback()},customInit:function(callback){callback()},updateNotificationSettings:function(){console.warn("updateNotificationSettings is not implemented")},notificationReceived:function(){console.warn("notificationReceived is not implemented")},debugMode:!1};$.extend(settings,options),app.settings=settings,app.debugMode=settings.debugMode,app.angularModules=settings.angularModules,app.notificationReceived=settings.notificationReceived,app.angularAppModule=angular.module("AppModule",["chondric"].concat(app.angularModules),function($controllerProvider){app.controllerProvider=$controllerProvider});var initEvents=function(callback){callback()},loadFirstPage=function(callback){if(app.scope.route)return callback();if(settings.loadPageFromHash&&location.hash.length>1&&location.hash.indexOf("access_token=")<0){for(var parts=location.hash.substr(2).split("/"),i=0;i<parts.length;i++)parts[i]=decodeURIComponent(parts[i]);app.changePage(parts)}else settings.firstPageTemplate&&app.changePage(settings.firstPageTemplate,"crossfade");callback()};app.splashScreenHidden=!1,app.hideSplashScreen=function(){app.splashScreenHidden||("cordova"==app.platform&&navigator&&navigator.splashscreen&&navigator.splashscreen.hide(),app.splashScreenHidden=!0)},app.registerForNotifications=function(){"cordova"==app.platform&&window.plugins&&window.plugins.pushNotification&&window.plugins.pushNotification.register(function(result){settings.updateNotificationSettings(result,!0)},function(error){console.error(error),settings.updateNotificationSettings(null,!1)},{badge:"true",sound:"true",alert:"true",ecb:"app.notificationReceived"})};var loadHostSettings=function(callback){$.ajax({url:"../settings.json"+location.search,dataType:"json",error:function(){console.warn("error loading ../settings.json - using default"),app.hostSettings={},callback()},success:function(data){app.hostSettings=data,void 0!==data.debug&&(app.debugMode=data.debug),callback()}})};app.init=function(){throw new Error("no longer need to call app.init manually")};var init=function(callback){console.log("beginning app initialization");var initInternal=function(){app.scope.platform=app.platform,app.scope.$apply();var sizeChanged=function(){var w=$(window).width(),h=$(window).height();console.log("Size changed: "+w+"x"+h),1024==h||768==h||320==h||568==h||480==h?$(".chondric-viewport").addClass("hasstatusbar"):$(".chondric-viewport").removeClass("hasstatusbar"),768>w&&1!=app.scope.maxColumns?(console.log("setting singlecolumn"),app.scope.maxColumns=1,$(".viewport").addClass("singlecolumn"),app.scope.$apply()):w>=768&&3!=app.scope.maxColumns&&(console.log("setting multicolumn"),app.scope.maxColumns=3,$(".viewport").removeClass("singlecolumn"),app.scope.$apply())};sizeChanged(),$(window).on("resize",sizeChanged),console.log("begin internal init"),initEvents(function(){loadHostSettings(function(){if(app.hostSettings.debug&&app.hostSettings.tests&&app.hostSettings.tests.length){$("head").append('<script src="bower_components/mocha/mocha.js"></script>'),$("head").append('<script>mocha.setup("'+(app.hostSettings.mochaInterface||"bdd")+'")</script>'),$("head").append('<link rel="stylesheet" href="bower_components/mocha/mocha.css" />'),$("head").append('<script src="bower_components/chai/chai.js"></script>');for(var i=0;i<app.hostSettings.tests.length;i++)$("head").append('<script src="'+app.hostSettings.tests[i]+'"></script>')}initData(function(){settings.loadData.call(app,null,function(){attachEvents(function(){window.NativeNav&&(window.NativeNav.handleAction=function(route,action){var routeScope=app.scopesForRoutes[route];routeScope&&routeScope.$apply(action)}),window.Keyboard&&(window.Keyboard.onshowing=function(){$("body").addClass("haskeyboard")},window.Keyboard.onhiding=function(){$("body").removeClass("haskeyboard")}),settings.customInit.call(app,function(){loadFirstPage(function(){complete(function(){callback&&callback()})})})})})})})})};settings.mightBePhoneGap&&"file:"==document.location.protocol?(app.isPhonegap=!0,app.platform="cordova",document.addEventListener("deviceready",function(){console.log("appframework deviceready"),window.device&&(app.isSimulator=window.device.platform.indexOf("Simulator")>0),$(initInternal)},!1)):(app.platform="web",$(initInternal))};return app.module.run(["$rootScope","$compile","$controller",function($rootScope){app.rootScope=$rootScope,init()}]),angular.element(document).ready(function(){angular.bootstrap(document,[app.module.name])}),app},Chondric.factory("sharedUi",function(){return{init:function($scope,componentAliases){var service={},app=$scope.app;service.route=$scope.rk,$scope.sharedUi=service,service.addComponent=function(alias,componentKey){service[alias]={setState:function(active,available,data){app.setSharedUiComponentState($scope,componentKey,active,available,data)},enable:function(data){app.setSharedUiComponentState($scope,componentKey,void 0,!0,data)},disable:function(){app.setSharedUiComponentState($scope,componentKey,!1,!1,void 0)},show:function(data){app.setSharedUiComponentState($scope,componentKey,!0,!0,data)},hide:function(disable){app.setSharedUiComponentState($scope,componentKey,!1,!disable,void 0)},replaceData:function(data){app.setSharedUiComponentState($scope,componentKey,void 0,void 0,data)},extendData:function(update){var state=app.getSharedUiComponentState($scope,componentKey),newData=$.extend(state.data||{},update);app.setSharedUiComponentState($scope,componentKey,state.active,state.available,newData)},updateState:function(fn){var state=app.getSharedUiComponentState($scope,componentKey);fn(state),app.setSharedUiComponentState($scope,componentKey,state.active,state.available,state.data)}}};for(var alias in componentAliases)service.addComponent(alias,componentAliases[alias]);return service}}}),angular.module("chondric").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("cjs-action-sheet.html",'<div cjs-popover="componentDefinition.popuptrigger">\n    <div class="poparrow"></div>\n    <button ng-repeat="b in componentDefinition.data.items" ng-tap="handleSharedPopupButtonClick(b)">{{b.title}}</button>\n</div>\n'),$templateCache.put("cjs-left-panel.html",'<div cjs-sidepanel="componentDefinition.popuptrigger">\n<div ng-if="componentDefinition.data.templateUrl || componentDefinition.contentTemplateUrl" ng-include="componentDefinition.data.templateUrl || componentDefinition.contentTemplateUrl"></div>\n<div ng-if="componentDefinition.data.jsonTemplate || componentDefinition.contentJsonTemplate" cjs-json-template="componentDefinition.data.jsonTemplate || componentDefinition.contentJsonTemplate" data="componentDefinition.data"></div>\n</div>'),$templateCache.put("cjs-loading-overlay-compact.html",'<div class="cjs-loading-overlay cjs-loading-overlay-compact">\n    <div ng-show="!error" class="progress small">\n        <div></div>\n    </div>\n    <div class="message" ng-show="!error">{{message || "Loading"}}</div>\n    <div class="error" ng-show="error">{{error}}</div>\n    <div class="buttons">\n        <button ng-show="retry && error" ng-tap="retry()">Retry</button>\n        <button ng-show="cancel" ng-tap="cancel()">Cancel</button>\n    </div>\n</div>\n'),$templateCache.put("cjs-loading-overlay-simple.html",'<div class="cjs-loading-overlay cjs-loading-overlay-simple">\n    <div ng-show="!error" class="progress small">\n        <div></div>\n    </div>\n    <div class="error" ng-show="error">{{error}}</div>\n</div>\n'),$templateCache.put("cjs-loading-overlay.html",'<div class="cjs-loading-overlay cjs-loading-overlay-full">\n    <div ng-show="!error" class="progress large">\n        <div></div>\n    </div>\n    <div class="title" ng-show="title && !error">{{title}}</div>\n     <div class="message" ng-show="!error">{{message || "Loading"}}</div>\n   <div class="error" ng-show="error">{{error}}</div>\n    <div class="buttons">\n        <button ng-show="retry && error" ng-tap="retry()">Retry</button>\n        <button ng-show="cancel" ng-tap="cancel()">Cancel</button>\n    </div>\n</div>\n'),$templateCache.put("cjs-navigation-bar.html",'<div class="navbar" ng-style="{\'-webkit-transform\': \'translate(0, \'+(-60 + (((globalHeaderOptions.v1.active && 60 || 0) * (1 - globalHeaderOptions.transitionState)) + ((globalHeaderOptions.v2.active && 60 || 0) * (globalHeaderOptions.transitionState))))+\'px)\' }">\n    <div class="v1" ng-style="{opacity:(1-globalHeaderOptions.transitionState), \'z-index\': ((globalHeaderOptions.transitionState > 0.5) ? 1: 2)  }">\n        <button class="left" ng-repeat="b in globalHeaderOptions.v1.data.leftButtons" ng-tap="handleSharedHeaderButtonClick(globalHeaderOptions.v1, b, lastTap)">{{b.title}}</button>\n        <h1 ng-show="!globalHeaderOptions.v1.data.titleEditable">{{globalHeaderOptions.v1.data.title}}</h1>\n        <input class="h1" ng-show="globalHeaderOptions.v1.data.titleEditable" type="text" ng-model="globalHeaderOptions.v1.data.title" ng-change="titleChanged()" />\n        <button class="right" ng-repeat="b in globalHeaderOptions.v1.data.rightButtons" ng-tap="handleSharedHeaderButtonClick(globalHeaderOptions.v1, b, lastTap)">{{b.title}}</button>\n    </div>\n    <div class="v2" ng-style="{opacity:(globalHeaderOptions.transitionState), \'z-index\': ((globalHeaderOptions.transitionState > 0.5) ? 2: 1)}">\n        <button class="left" ng-repeat="b in globalHeaderOptions.v2.data.leftButtons" ng-tap="handleSharedHeaderButtonClick(globalHeaderOptions.v2, b, lastTap)">{{b.title}}</button>\n        <h1 ng-show="!globalHeaderOptions.v2.data.titleEditable">{{globalHeaderOptions.v2.data.title}}</h1>\n        <input class="h1" ng-show="globalHeaderOptions.v2.data.titleEditable" type="text" ng-model="globalHeaderOptions.v2.data.title" ng-change="titleChanged()" />\n        <button class="right" ng-repeat="b in globalHeaderOptions.v2.data.rightButtons" ng-tap="handleSharedHeaderButtonClick(globalHeaderOptions.v2, b, lastTap)">{{b.title}}</button>\n    </div>\n</div>\n'),$templateCache.put("cjs-preview-controls.html","<div id='previewcontrols'>\n    <button ng-tap='updatePreviewSettings(1024,768, true)'>iPad landscape</button>\n    <button ng-tap='updatePreviewSettings(768, 1024, true)'>iPad portrait</button>\n    <button ng-tap='updatePreviewSettings(568,320, true)'>iPhone5 landscape</button>\n    <button ng-tap='updatePreviewSettings(320, 568, true)'>iPhone5 portrait</button>\n    <button ng-tap='updatePreviewSettings(1024,748, false)'>iPad landscape iOS6</button>\n    <button ng-tap='updatePreviewSettings(768, 1004, false)'>iPad portrait iOS6</button>\n    <button ng-tap='updatePreviewSettings(568,300, false)'>iPhone5 landscape iOS6</button>\n    <button ng-tap='updatePreviewSettings(320,548, false)'>iPhone5 portrait iOS6</button>\n    <button ng-tap='reloadPreview()'>Reload</button>\n</div>\n"),$templateCache.put("cjs-right-panel.html",'<div cjs-sidepanel="componentDefinition.popuptrigger">\n<div ng-if="componentDefinition.data.templateUrl || componentDefinition.contentTemplateUrl" ng-include="componentDefinition.data.templateUrl || componentDefinition.contentTemplateUrl"></div>\n<div ng-if="componentDefinition.data.jsonTemplate || componentDefinition.contentJsonTemplate" cjs-json-template="componentDefinition.data.jsonTemplate || componentDefinition.contentJsonTemplate" data="componentDefinition.data"></div>\n\n</div>'),$templateCache.put("cjs-shared-popup.html",'<div cjs-popup="componentDefinition.popuptrigger" ng-class="{nativetransition: componentDefinition.nativeTransition}">\n<div ng-if="componentDefinition.data.templateUrl || componentDefinition.contentTemplateUrl" ng-include="componentDefinition.data.templateUrl || componentDefinition.contentTemplateUrl"></div>\n<div ng-if="componentDefinition.data.jsonTemplate || componentDefinition.contentJsonTemplate" cjs-json-template="componentDefinition.data.jsonTemplate || componentDefinition.contentJsonTemplate" data="componentDefinition.data"></div>\n\n</div>'),$templateCache.put("cjs-tab-footer.html",'<div class="tabbar" ng-show="componentDefinition.active">\n\n    <button ng-repeat="tab in componentDefinition.data.buttons track by tab.value"  ng-tap="setTab(tab.value)" ng-class="{selected: tab.value == componentDefinition.selectedTab}" class="icon-top icon-custom"><div class="maskedicon" ng-style="{\'-webkit-mask-image\': \'url(\'+tab.icon+\')\'}"></div> {{tab.title}}</button>\n\n    \n</div>')}]),Chondric.VersionedDatabase=function(db,updatefunctions,tables){this.sqlerror=function(t,err){throw new Error(err&&err.message?err.message:t&&t.message?t.message:err?err:t?t:"sql error")};var sqlerror=this.sqlerror,getVersion=function(versionCallback){console.log("checking version"),db.transaction(function(tx){tx.executeSql("SELECT * FROM settings where key=?",["dbVersion"],function(t,result){if(0===result.rows.length)return versionCallback(0);var row=result.rows[0]||result.rows.item(0);window.setTimeout(function(){return versionCallback(parseFloat(row.val))},0)},function(){window.setTimeout(function(){versionCallback(0)},0)})},function(){window.setTimeout(function(){versionCallback(0)},0)})};this.updateDatabase=function(callback){getVersion(function(currentVersion){console.log("Current database version is "+currentVersion);var existingversion=currentVersion,versionQueue=[];for(var vn in updatefunctions){var vv=parseFloat(vn);vv>existingversion&&versionQueue.push(vn)}return 0===versionQueue.length?callback():void db.transaction(function(tx){for(var vn in updatefunctions){var vv=parseFloat(vn);vv>existingversion&&(updatefunctions[vn](tx),tx.executeSql("INSERT OR REPLACE INTO settings (key, val) VALUES (?, ?)",["dbVersion",vv],null,sqlerror),existingversion=vv)}},sqlerror,function(){callback()})})},this.dropDatabase=function(callback){db.transaction(function(tx){for(var tn in tables)tx.executeSql("DROP TABLE "+tn,[],null,sqlerror)},sqlerror,function(){callback()})},this.resetDatabase=function(callback){var that=this;this.dropDatabase(function(){that.updateDatabase(callback)})}},Chondric.directive("ngTap",function(){return function(scope,element,attrs){function start(e){startX=e.originalEvent.touches?e.originalEvent.touches[0].clientX:e.clientX,startY=e.originalEvent.touches?e.originalEvent.touches[0].clientY:e.clientY,useMouse?(element.bind("mousemove",move),element.bind("mouseout",cancel),element.bind("mouseup",action)):(element.bind("touchmove",move),element.bind("touchend",action)),element.addClass("active"),element.removeClass("deactivated"),active=!0}element.addClass("tappable");var active=!1,touching=!1,startX=0,startY=0,move=function(e){var x=e.originalEvent.touches?e.originalEvent.touches[0].clientX:e.clientX,y=e.originalEvent.touches?e.originalEvent.touches[0].clientY:e.clientY;(Math.abs(x-startX)>10||Math.abs(y-startY)>10)&&cancel(e)},cancel=function(){useMouse?(element.unbind("mousemove",move),element.unbind("mouseout",cancel),element.unbind("mouseup",action)):(element.unbind("touchmove",move),element.unbind("touchend",action)),element.removeClass("active"),element.addClass("deactivated"),touching=!1,active=!1},action=function(e){scope.lastTap={element:element,x:e.originalEvent.changedTouches?e.originalEvent.changedTouches[0].clientX:e.clientX,y:e.originalEvent.changedTouches?e.originalEvent.changedTouches[0].clientY:e.clientY},useMouse?(element.unbind("mousemove",move),element.unbind("mouseout",cancel),element.unbind("mouseup",action)):(element.unbind("touchmove",move),element.unbind("touchend",action)),touching=!1,active=!1,element.removeClass("active"),element.addClass("deactivated"),window.setTimeout(function(){scope.$apply(attrs.ngTap,element)},0)},mouseStart=function(e){active||touching||(touching=!1,start(e))},touchStart=function(e){active||(touching=!0,start(e))},useMouse=!0,iOS=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1;iOS?(useMouse=!1,element.bind("touchstart",touchStart)):element.bind("mousedown",mouseStart)}}),Chondric.directive("cjsLoadingOverlay",function($templateCache,$compile){return{restrict:"A",scope:!0,link:function(scope,element,attrs){var contentElement;contentElement=1==element.children().length?element.children().first():element.wrapInner("<div/>").children().first();var overlay;overlay=angular.element("compact"==attrs.overlayType?$templateCache.get("cjs-loading-overlay-compact.html"):"simple"==attrs.overlayType?$templateCache.get("cjs-loading-overlay-simple.html"):$templateCache.get("cjs-loading-overlay.html")),element.append(overlay),element.addClass("cjs-loading-overlay-container"),$compile(overlay)(scope),scope.loadStatus.onUpdate(scope.$eval(attrs.cjsLoadingOverlay),function(taskGroup){scope.taskGroup=taskGroup,scope.currentTask=taskGroup.currentTask,taskGroup.completed?(scope.message="finished",void 0===attrs.showUnloaded&&contentElement.addClass("ui-show").removeClass("ui-hide"),contentElement.addClass("cjs-loaded").removeClass("cjs-unloaded"),overlay.addClass("ui-hide").removeClass("ui-show")):(void 0===attrs.showUnloaded&&contentElement.addClass("ui-hide").removeClass("ui-show"),contentElement.addClass("cjs-unloaded").removeClass("cjs-loaded"),contentElement.addClass("cjs-unloaded"),overlay.addClass("ui-show").removeClass("ui-hide"),scope.title=taskGroup.title,scope.error=taskGroup.error,scope.message=taskGroup.message)})}}}),Chondric.directive("cjsShowAfterLoad",function(){return{link:function(scope,element,attrs){scope.loadStatus.onUpdate(scope.$eval(attrs.cjsShowAfterLoad),function(taskGroup){taskGroup.completed?element.addClass("ui-show").removeClass("ui-hide"):element.addClass("ui-hide").removeClass("ui-show")})}}}),Chondric.factory("loadStatus",function(){return{init:function($scope,tasks){var service={},existing=$scope.loadStatus;if(existing?($.extend(service,existing),service.allTasks=[].concat(existing.allTasks)):service.allTasks=[],$scope.loadStatus=service,service.registerTask=function(key,taskOptions){var task={key:key,title:"Untitled Task",progressCurrent:0,progressTotal:1,active:!1,message:"Message Here...",error:null,start:function(){task.active=!0,task.error=null,task.progressCurrent=0},finish:function(){task.progressCurrent=task.progressTotal,task.completed=!0,task.active=!1},fail:function(message){task.active=!1,task.error=message},progress:function(progress,total,message){task.active=!0,task.progressCurrent=progress,void 0!==total&&(task.progressTotal=total),void 0!==message&&(task.message=message)}};$.extend(task,taskOptions),service[key]=task,service.allTasks.push(task)},service.onUpdate=function(tasksOrKeys,fn){tasksOrKeys=tasksOrKeys||service.allTasks;for(var watchedKeys=[],i=0;i<tasksOrKeys.length;i++){var t=tasksOrKeys[i];"string"==typeof t?watchedKeys.push(t):t.key&&watchedKeys.push(t.key)}return 0===watchedKeys.length?fn({tasks:[],completed:!0}):void $scope.$watch("[loadStatus."+watchedKeys.join(",loadStatus.")+"]",function(tasks){if(tasks){var result={tasks:tasks};result.currentTask=void 0;for(var i=0;i<tasks.length;i++){var task=tasks[i];if(task.error){result.currentTask=task;break}if(task.active){result.currentTask=task;break}if(task.progressCurrent<task.progressTotal&&(!result.currentTask||task.progressTotal>result.currentTask.progressTotal)){result.currentTask=task;break}}result.currentTask?(result.completed=!1,result.title=result.currentTask.title,result.error=result.currentTask.error,result.message=result.currentTask.message||result.currentTask.progressCurrent+" / "+result.currentTask.progressTotal):(result.message="finished",result.completed=!0),fn(result)}},!0)},service.after=function(tasksOrKeys,fn){service.onUpdate(tasksOrKeys,function(taskGroup){return taskGroup.completed?fn():void 0})},tasks)for(var tk in tasks)service.registerTask(tk,tasks[tk]);return service}}}),Chondric.directive("cjsPopover",function(){return{link:function(scope,element,attrs){function clickOutsidePopup(e){element[0]==e.target||element[0].contains(e.target)||scope.$apply("hideModal('"+attrs.cjsPopover+"')")}function ensureOverlay(element,useOverlay){var parentPageElement=element.closest(".chondric-page");if(0===parentPageElement.length&&(parentPageElement=element.closest(".chondric-section")),0===parentPageElement.length&&(parentPageElement=element.closest(".chondric-viewport")),useOverlay){var overlay=$(".modal-overlay",parentPageElement);return 0===overlay.length&&(overlay=angular.element('<div class="modal-overlay"></div>'),parentPageElement.append(overlay)),overlay}}var useOverlay=void 0===attrs.noOverlay,horizontal=void 0!==attrs.horizontal,menuwidth=parseFloat(attrs.menuwidth)||280,menuheight=parseFloat(attrs.menuheight)||150,useMouse=!0,iOS=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1;iOS&&(useMouse=!1),element.addClass("modal"),element.addClass("popover"),scope.$watch(attrs.cjsPopover,function(val){document.activeElement&&useOverlay&&document.activeElement.blur();var overlay=ensureOverlay(element,useOverlay);if(val){window.document.addEventListener(useMouse?"mousedown":"touchstart",clickOutsidePopup,!0),menuheight=element.height()||menuheight,menuwidth=element.width()||menuwidth;var menupos={},sw=element[0].offsetParent.offsetWidth,sh=element[0].offsetParent.offsetHeight,horizontalCutoff=sw/2,verticalCutoff=sh/2,idealX=0,idealY=0;if(val.element&&val.element[0]){var button=val.element[0],cr=button.getBoundingClientRect();horizontal?(idealX=cr.right>horizontalCutoff?cr.right:cr.left,idealY=cr.top+cr.height/2):(idealX=cr.left+cr.width/2,idealY=cr.bottom>verticalCutoff?cr.top:cr.bottom)}else idealX=val.x||0,idealY=val.y||0;var actualX=idealX,actualY=idealY;horizontal?(0>idealY-10-menuheight/2&&(actualY=menuheight/2+10),idealY+10+menuheight/2>sh&&(actualY=sh-menuheight/2-10)):(0>idealX-10-menuwidth/2&&(actualX=menuwidth/2+10),idealX+10+menuwidth/2>sw&&(actualX=sw-menuwidth/2-10)),horizontal?(horizontalCutoff>actualX?(menupos.left=actualX+13+"px",menupos.right="auto",element.addClass("right").removeClass("left")):(menupos.right=sw-actualX+13+"px",menupos.left="auto",element.addClass("left").removeClass("right")),menupos.top=actualY-menuheight/2+"px"):(verticalCutoff>actualY?(menupos.top=actualY+13+"px",menupos.bottom="auto",element.addClass("down").removeClass("up")):(menupos.bottom=sh-actualY+13+"px",menupos.top="auto",element.addClass("up").removeClass("down")),menupos.left=actualX-menuwidth/2+"px");
var indel=$(".poparrow",element);if(indel.length>0)if(horizontal){var arrowtop=idealY-(actualY-menuheight/2)-13;10>arrowtop&&(arrowtop=10),arrowtop+26>menuheight-10&&(arrowtop=menuheight-10-26),indel.css("top",arrowtop+"px")}else{var arrowleft=idealX-(actualX-menuwidth/2)-13;10>arrowleft&&(arrowleft=10),arrowleft+26>menuwidth-10&&(arrowleft=menuwidth-10-26),indel.css("left",arrowleft+"px")}useOverlay&&overlay.addClass("active"),element.addClass("active"),element.css(menupos)}else useOverlay&&overlay.removeClass("active"),element.removeClass("active"),window.document.removeEventListener(useMouse?"mousedown":"touchstart",clickOutsidePopup,!0)})}}}),Chondric.directive("cjsPopup",function(){return{link:function(scope,element,attrs){function clickOutsidePopup(e){element[0]==e.target||element[0].contains(e.target)||scope.$apply("hideModal('"+attrs.cjsPopup+"')")}var useMouse=!0,iOS=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1;iOS&&(useMouse=!1),element.addClass("modal"),element.addClass("popup");var parentPageElement=element.closest(".chondric-page");0===parentPageElement.length&&(parentPageElement=element.closest(".chondric-section")),0===parentPageElement.length&&(parentPageElement=element.closest(".chondric-viewport"));var overlay=$(".modal-overlay",parentPageElement);0===overlay.length&&(overlay=angular.element('<div class="modal-overlay"></div>'),parentPageElement.append(overlay)),scope.$watch(attrs.cjsPopup,function(val){document.activeElement&&document.activeElement.blur(),element.hasClass("nativetransition")?val?element.addClass("active"):element.removeClass("active"):val?(window.document.addEventListener(useMouse?"mousedown":"touchstart",clickOutsidePopup,!0),overlay.addClass("active"),element.addClass("active")):(overlay.removeClass("active"),element.removeClass("active"),window.document.removeEventListener(useMouse?"mousedown":"touchstart",clickOutsidePopup,!0))})}}}),Chondric.directive("cjsSidepanel",function(){var panelTransitions={revealRight:{init:function(){},progress:function(){},cancel:function(){},complete:function(){},reset:function(){}},coverRight:{init:function(panel,page,overlay){var spwidth=panel.width();overlay.css({visibility:"visible","-webkit-transition":"none",opacity:"0"}),panel.css({right:0,left:"auto",display:"block","-webkit-transition":"none","-webkit-transform":"translate("+spwidth+"px, 0)"})},progress:function(panel,page,overlay,progress){var spwidth=panel.width();overlay.css({visibility:"visible","-webkit-transition":"none",opacity:.3*progress}),panel.css({right:0,left:"auto",display:"block","-webkit-transition":"none","-webkit-transform":"translate("+(spwidth-progress*spwidth)+"px, 0)"})},cancel:function(panel,page,overlay,prevProgress){var time=300*prevProgress,spwidth=panel.width();return overlay.css({visibility:"visible","-webkit-transition":"opacity "+time+"ms ease-in-out",opacity:"0"}),panel.css({display:"block","-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate("+spwidth+"px, 0)"}),time},complete:function(panel,page,overlay,prevProgress){var time=300*(1-prevProgress);return overlay.css({visibility:"visible","-webkit-transition":"opacity "+time+"ms ease-in-out",opacity:"0.3"}),panel.css({display:"block","-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(0px, 0)"}),time},reset:function(panel,page,overlay){overlay.css({visibility:"","-webkit-transition":"",opacity:""}),panel.css({display:"","-webkit-transition":"","-webkit-transform":"",right:0,left:"auto"})}},slideRight:{init:function(){},progress:function(){},cancel:function(){},complete:function(){},reset:function(){}},revealLeft:{init:function(){},progress:function(){},cancel:function(){},complete:function(){},reset:function(){}},coverLeft:{init:function(panel,page,overlay){var spwidth=panel.width();overlay.css({visibility:"visible","-webkit-transition":"none",opacity:"0"}),panel.css({left:0,right:"auto",display:"block","-webkit-transition":"none","-webkit-transform":"translate("+-spwidth+"px, 0)"})},progress:function(panel,page,overlay,progress){var spwidth=panel.width();overlay.css({visibility:"visible","-webkit-transition":"none",opacity:.3*progress}),panel.css({left:0,right:"auto",display:"block","-webkit-transition":"none","-webkit-transform":"translate("+(-spwidth+progress*spwidth)+"px, 0)"})},cancel:function(panel,page,overlay,prevProgress){var time=300*prevProgress,spwidth=panel.width();return overlay.css({visibility:"visible","-webkit-transition":"opacity "+time+"ms ease-in-out",opacity:"0"}),panel.css({display:"block","-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate("+-spwidth+"px, 0)"}),time},complete:function(panel,page,overlay,prevProgress){var time=300*(1-prevProgress);return overlay.css({visibility:"visible","-webkit-transition":"opacity "+time+"ms ease-in-out",opacity:"0.3"}),panel.css({display:"block","-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(0px, 0)"}),time},reset:function(panel,page,overlay){overlay.css({visibility:"","-webkit-transition":"",opacity:""}),panel.css({display:"","-webkit-transition":"","-webkit-transform":"",left:0,right:"auto"})}},slideLeft:{init:function(){},progress:function(){},cancel:function(){},complete:function(){},reset:function(){}}};return{link:function(scope,element,attrs){function clickOutsidePopup(e){element[0]==e.target||element[0].contains(e.target)||scope.$apply("hideModal('"+attrs.cjsSidepanel+"')")}var useMouse=!0,iOS=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1;iOS&&(useMouse=!1),element.addClass("modal"),element.addClass("sidepanel");var pushmode;element.hasClass("left")?element.hasClass("push")&&(pushmode="right"):(element.addClass("right"),element.hasClass("push")&&(pushmode="left"));var parentPageElement=element.closest(".chondric-page");0===parentPageElement.length&&(parentPageElement=element.closest(".chondric-section")),0===parentPageElement.length&&(parentPageElement=element.closest(".chondric-viewport"));var overlay=$(".modal-overlay",parentPageElement);0===overlay.length&&(overlay=angular.element('<div class="modal-overlay"></div>'),parentPageElement.append(overlay)),pushmode&&parentPageElement.addClass("haspushpanel"),scope.$watch(attrs.cjsSidepanel,function(val,oldval){if(val||oldval){!document.activeElement||(!val||oldval)&&val&&oldval&&val.progress==oldval.progress||document.activeElement.blur();var transition="coverRight",progress=0,oldprogress=0,spwidth=element.width()||200,dwidth=$(document).width();if(val&&val.transition?transition=val.transition:oldval&&oldval.transition&&(transition=oldval.transition),progress=val&&val.progress?Math.min(1,val.progress*dwidth/spwidth):0,oldprogress=oldval&&oldval.progress?Math.min(1,oldval.progress*dwidth/spwidth):0,1==progress)overlay.addClass("active"),window.document.addEventListener(useMouse?"mousedown":"touchstart",clickOutsidePopup,!0),oldprogress||panelTransitions[transition].init(element,parentPageElement,overlay),window.setTimeout(function(){panelTransitions[transition].complete(element,parentPageElement,overlay,oldprogress)},0);else if(0===progress){var time=panelTransitions[transition].cancel(element,parentPageElement,overlay,oldprogress);window.setTimeout(function(){panelTransitions[transition].reset(element,parentPageElement,overlay)},time),overlay.removeClass("active"),window.document.removeEventListener(useMouse?"mousedown":"touchstart",clickOutsidePopup,!0)}else panelTransitions[transition].progress(element,parentPageElement,overlay,progress),overlay.addClass("active"),window.document.addEventListener(useMouse?"mousedown":"touchstart",clickOutsidePopup,!0)}})}}}),Chondric.directive("cjsSwipe",function(){return{link:function(scope,element){function move(e){e.originalEvent.changedTouches?(dx=e.originalEvent.changedTouches[0].clientX-startX,dy=e.originalEvent.changedTouches[0].clientY-startY):(dx=e.clientX-startX,dy=e.clientY-startY),swipeState.left?swipeState.left=Math.max(0,-dx/width):swipeState.right?swipeState.right=Math.max(0,dx/width):swipeState.leftBorder?swipeState.leftBorder=Math.max(0,dx/width):swipeState.rightBorder?swipeState.rightBorder=Math.max(0,-dx/width):swipeState.up?swipeState.up=Math.max(0,-dy/height):swipeState.down?swipeState.down=Math.max(0,dy/height):swipeState.topBorder?swipeState.topBorder=Math.max(0,dy/height):swipeState.bottomBorder?swipeState.bottomBorder=Math.max(0,-dy/height):dx>threshold&&Math.abs(dy)<threshold?10>startX?swipeState.leftBorder=dx/width:swipeState.right=dx/width:-dx>threshold&&Math.abs(dy)<threshold?startX>width-10?swipeState.rightBorder=-dx/width:swipeState.left=-dx/width:dy>threshold&&Math.abs(dx)<threshold?10>startY?swipeState.topBorder=dy/height:swipeState.down=dy/height:-dy>threshold&&Math.abs(dx)<threshold&&(startY>height-10?swipeState.bottomBorder=-dy/height:swipeState.up=-dy/height),updateSwipe&&updateSwipe(swipeState,swipeNav,scope)}function end(){tracking&&(tracking=!1,$(document).off(useMouse?"mousemove":"touchmove",move),$(document).off(useMouse?"mouseup":"touchend",end),endSwipe&&endSwipe(swipeState,swipeNav,scope),swipeState={left:0,right:0,up:0,down:0,leftBorder:0,rightBorder:0,topBorder:0,bottomBorder:0})}var useMouse=!0,iOS=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1;iOS&&(useMouse=!1);var swipeNav,startX=0,startY=0,threshold=20,dx=0,dy=0,width=0,height=0,swipeState={left:0,right:0,up:0,down:0,leftborder:0,rightborder:0,topborder:0,bottomborder:0},tracking=!1,updateSwipe=scope.$eval("updateSwipe"),endSwipe=scope.$eval("endSwipe");element.on(useMouse?"mousedown":"touchstart",function(e){tracking||(tracking=!0,e.originalEvent.changedTouches?(startX=e.originalEvent.changedTouches[0].clientX,startY=e.originalEvent.changedTouches[0].clientY):(startX=e.clientX,startY=e.clientY),dx=0,dy=0,width=element.width(),height=element.height(),swipeState={left:0,right:0,up:0,down:0,leftBorder:0,rightBorder:0,topBorder:0,bottomBorder:0},$(document).on(useMouse?"mousemove":"touchmove",move),$(document).on(useMouse?"mouseup":"touchend",end),swipeNav=scope.$eval("swipeNav"))})}}}),Chondric.directive("cjsTransitionStyle",function(){return{link:function($scope,element,attrs){$scope.$watch("transition",function(transition,old){if(transition){var td=Chondric.allTransitions[transition.type];if(td){var time,isNewTransition=!old||transition.from!=old.from||transition.to!=old.to||0===old.progress||1==old.progress;attrs.route==transition.to?0===transition.progress&&isNewTransition?td.transitionIn.start(element):0!==transition.progress||isNewTransition?1==transition.progress?(time=td.transitionIn.complete(element,old.progress),window.setTimeout(function(){td.reset(element)},time)):td.transitionIn.progress(element,transition.progress):(time=td.transitionIn.cancel(element,old.progress),window.setTimeout(function(){td.reset(element)},time)):attrs.route==transition.from&&(0===transition.progress&&isNewTransition?td.transitionOut.start(element):0!==transition.progress||isNewTransition?1==transition.progress?(time=td.transitionOut.complete(element,old.progress),window.setTimeout(function(){td.reset(element)},time)):td.transitionOut.progress(element,transition.progress):(time=td.transitionOut.cancel(element,old.progress),window.setTimeout(function(){td.reset(element)},time)))}}},!0)}}}),Chondric.directive("cjsPreviewControls",function(){return{restrict:"AE",replace:!0,templateUrl:"cjs-preview-controls.html",link:function(scope){scope.previewSettings={width:1024,height:768,overlayStatusBar:!0},scope.reloadPreview=function(){document.getElementById("preview").contentDocument.location.reload(!0)},scope.updatePreviewSettings=function(w,h,overlayStatusBar){scope.previewSettings={width:w,height:h,overlayStatusBar:overlayStatusBar}}}}}),Chondric.directive("chondricViewport",function($compile){return{scope:!0,link:function(scope,element,attrs){var rk=scope.$eval("rk"),rv=scope.$eval("rv");if(rv){scope.pageParams=rv.params||{};for(var k in rv.params)scope[k]=rv.params[k]}if(rk&&(scope.pageRoute=rk),rk||"1"!=attrs["chondric-viewport"]){var template="";rv?rv.isSection?(template='<div ng-controller="rv.controller" >',template+='<div ng-repeat="(rk, rv) in rv.subsections" chondric-viewport="1" class="{{rv.templateId}}" ng-class="{\'chondric-section\': rv.isSection, \'chondric-page\': !rv.isSection, active: rk == route, next: rk == nextRoute, prev: rk == lastRoute}" cjs-transition-style route="{{rk}}">',template+="</div>",template+="</div>"):rv.templateUrl?(template='<div  ng-controller="rv.controller" cjs-swipe class="{{usedComponents.asString}}"> <div ng-include src="rv.templateUrl"></div>',template+="</div>",scope.usedComponents={asArray:[],asString:""}):template="<span>Template not set</span>":(element.addClass("chondric-viewport"),template='<div ng-repeat="(rk, rv) in openViews" chondric-viewport="1" class="{{rv.templateId}}" ng-class="{\'chondric-section\': rv.isSection, \'chondric-page\': !rv.isSection, active: rk == route, next: rk == nextRoute, prev: rk == lastRoute}" cjs-transition-style route="{{rk}}">',template+="</div>",template+="<div ng-repeat=\"(ck, componentDefinition) in sharedUiComponents\" cjs-shared-component testattr='{{componentId}}'>",template+="</div>");var newElement=angular.element(template);$compile(newElement)(scope),element.html(""),element.append(newElement)}}}}),Chondric.directive("cjsSharedComponent",function($compile){return{scope:!0,link:function(scope,element){var cd=scope.componentDefinition;if(!cd.isNative||!cd.isNative()){element.addClass("sharedcomponent-"+cd.id);var template="";template+="<div ng-if='!componentDefinition.isNative()' ng-controller=\"componentDefinition.controller\" >",cd.template?template+=cd.template:cd.templateUrl&&(template+='<div ng-include src="componentDefinition.templateUrl"></div>'),template+="</div>";var newElement=angular.element(template);$compile(newElement)(scope),element.html(""),element.append(newElement)}}}}),Chondric.directive("cjsJsonTemplate",function($compile){var templates={container:function(template){for(var html="",i=0;i<template.children.length;i++)html+=templates[template.children[i].type](template.children[i]);return html},body:function(template){for(var html="",i=0;i<template.children.length;i++)html+=templates[template.children[i].type](template.children[i]);return"<div class='body'>"+html+"</div>"},h2:function(template){return"<h2>{{data."+template.data+"}}</h2>"},p:function(template){return"<p>{{data."+template.data+"}}</p>"}};return{template:"Testing a template...",scope:{template:"=cjsJsonTemplate"},link:function(scope,element,attrs){var template=scope.template,html=templates[template.type](template),newElement=angular.element(html);$compile(newElement)(scope),element.html(""),element.append(newElement),scope.$parent.$watch(attrs.data,function(val){scope.data=val})}}}),Chondric.registerSharedUiComponent({id:"cjs-action-sheet",templateUrl:"cjs-action-sheet.html",isNative:function(){return window.NativeNav},controller:function($scope){var self=$scope.componentDefinition;$scope.hideModal=function(){self.popuptrigger=null;var routeScope=self.app.scopesForRoutes[self.route];self.app.setSharedUiComponentState(routeScope,"cjs-action-sheet",!1,!0,null)},$scope.handleSharedPopupButtonClick=function(b){self.popuptrigger=null;var routeScope=self.app.scopesForRoutes[self.route];self.app.setSharedUiComponentState(routeScope,"cjs-action-sheet",!1,!0,null),routeScope&&b.action&&routeScope.$eval(b.action)}},setState:function(self,route,active,available,data){if(self.data=data,self.route=route,window.NativeNav){if(active&&data.element&&data.element.length>0){var rect=data.element[0].getBoundingClientRect();window.NativeNav.showPopupMenu(route,rect.left,rect.top,rect.width,rect.height,data.items)}}else self.popuptrigger=active?{element:data.element}:null}}),Chondric.registerSharedUiComponent({id:"cjs-navigation-bar",templateUrl:"cjs-navigation-bar.html",isNative:function(){return window.NativeNav&&!0||!1},controller:function($scope){var self=$scope.componentDefinition;self.scope=$scope,$scope.globalHeaderOptions=self.globalHeaderOptions={},$scope.handleSharedHeaderButtonClick=function(headerOptions,b,lastTap){var routeScope=self.app.scopesForRoutes[self.route];routeScope&&b.action?routeScope.$eval(b.action):routeScope&&b.items&&self.app.setSharedUiComponentState(routeScope,"cjs-action-sheet",!0,!0,{element:lastTap.element,items:b.items})},$scope.titleChanged=function(){var routeScope=self.app.scopesForRoutes[self.route];routeScope&&self.data.titleChanged&&routeScope.$eval(self.data.titleChanged)(self.data.title)}},setState:function(self,route,active,available,data){if(self.globalHeaderOptions)if(self.route=route,self.data=data,window.NativeNav)window.NativeNav.showNavbar(route,active,data.leftButtons,data.title,data.rightButtons,data.titleChanged);else{var v1=self.globalHeaderOptions.v1;v1&&v1.route==route?(self.globalHeaderOptions.v1={route:route,active:active,available:available,data:data},self.globalHeaderOptions.transitionState=0):(self.globalHeaderOptions.v2={route:route,active:active,available:available,data:data},self.globalHeaderOptions.transitionState=1)}}}),Chondric.registerSharedUiComponent({id:"cjs-tab-footer",templateUrl:"cjs-tab-footer.html",isNative:function(){return!1},controller:function($scope){var self=$scope.componentDefinition;self.scope=$scope,$scope.componentId=self.id,$scope.setTab=function(val){self.selectedTab=val;var routeScope=self.app.scopesForRoutes[self.route];routeScope&&routeScope.$eval(self.data.setTab||"setTab")(val)}},setState:function(self,route,active,available,data){self.data=data,self.route=route,self.active=active,self.available=available,self.selectedTab=data.selectedTab}}),Chondric.registerSharedUiComponent({id:"cjs-shared-popup",templateUrl:"cjs-shared-popup.html",isNative:function(){return!1},controller:function($scope){var self=$scope.componentDefinition;self.scope=$scope,self.defaultController=function(){},$scope.hideModal=function(){var routeScope=self.app.scopesForRoutes[self.route];self.data.closeCallback&&routeScope.$eval(self.data.closeCallback)(self.data),self.app.setSharedUiComponentState(routeScope,"cjs-shared-popup",!1,!0,self.data)},$scope.runOnMainScope=function(funcName,params){var routeScope=self.app.scopesForRoutes[self.route];routeScope&&routeScope.$eval(funcName).apply(void 0,params)},$scope.runOnMainScopeAndClose=function(funcName,params){$scope.hideModal();var routeScope=self.app.scopesForRoutes[self.route];routeScope&&routeScope.$eval(funcName).apply(void 0,params)}},setState:function(self,route,active,available,data){self.data=data,self.route=route,window.NativeNav?active&&!self.popuptrigger?window.NativeNav.startNativeTransition("popup",function(){screen.width<600?document.getElementById("viewport").setAttribute("content","width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0"):document.getElementById("viewport").setAttribute("content","width=500, height=500, initial-scale=1, maximum-scale=1, user-scalable=0"),self.popuptrigger={},self.nativeTransition=!0,self.app.scopesForRoutes[self.route].$apply()}):!active&&self.popuptrigger&&window.NativeNav.startNativeTransition("closepopup",function(){document.getElementById("viewport").setAttribute("content","width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0"),self.popuptrigger=null,self.app.scopesForRoutes[self.route].$apply()}):self.popuptrigger=active?{}:null}}),Chondric.registerSharedUiComponent({id:"cjs-right-panel",templateUrl:"cjs-right-panel.html",handledSwipeState:"rightBorder",transition:"coverRight",isNative:function(){return!1},controller:function($scope){var self=$scope.componentDefinition;self.scope=$scope,$scope.componentId=self.id,self.defaultController=function(){},$scope.hideModal=function(){var routeScope=self.app.scopesForRoutes[self.route];self.data.closeCallback&&routeScope.$eval(self.data.closeCallback)(self.data),self.app.setSharedUiComponentState(routeScope,self.id,!1,!0,self.data)},$scope.runOnMainScope=function(funcName,params){var routeScope=self.app.scopesForRoutes[self.route];routeScope&&routeScope.$eval(funcName).apply(void 0,params)},$scope.runOnMainScopeAndClose=function(funcName,params){$scope.hideModal();var routeScope=self.app.scopesForRoutes[self.route];routeScope&&routeScope.$eval(funcName).apply(void 0,params)}},setPanelPosition:function(self,progress){self.popuptrigger={progress:progress,transition:self.transition}},setState:function(self,route,active,available,data){self.data=data,self.route=route,self.active=active,self.available=available,active?self.setPanelPosition(self,1):self.setPanelPosition(self,0)},updateSwipe:function(self,swipeState){self.available&&(self.active||swipeState[self.handledSwipeState]&&(self.setPanelPosition(self,swipeState[self.handledSwipeState]),self.scope.$apply()))},endSwipe:function(self,swipeState){self.available&&(self.active||swipeState[self.handledSwipeState]&&(swipeState[self.handledSwipeState]<.1?(self.setPanelPosition(self,0),self.scope.$apply()):(self.setPanelPosition(self,1),self.scope.$apply())))}}),Chondric.registerSharedUiComponent({id:"cjs-left-panel",baseComponentId:"cjs-right-panel",templateUrl:"cjs-left-panel.html",handledSwipeState:"leftBorder",transition:"coverLeft",controller:function($scope){var self=$scope.componentDefinition;self.baseController("cjs-right-panel",$scope),$scope.hideModal=function(){var routeScope=self.app.scopesForRoutes[self.route];self.data.closeCallback&&routeScope.$eval(self.data.closeCallback)(self.data),self.app.setSharedUiComponentState(routeScope,self.id,!1,!0,self.data)}}}),Chondric.allTransitions.crossfade={transitionIn:{start:function(element){element.css({display:"block",opacity:0,"z-index":9})},cancel:function(element,prevProgress){var time=300*prevProgress;return $(element).css({"-webkit-transition":"opacity "+time+"ms ease-in-out",opacity:0}),time},complete:function(element,prevProgress){var time=300*(1-prevProgress);return $(element).css({"-webkit-transition":"opacity "+time+"ms ease-in-out",opacity:1}),time},progress:function(element,progress){element.css({display:"block",opacity:progress,"z-index":9})}},transitionOut:{start:function(element){element.css({display:"block"})},cancel:function(element,prevProgress){var time=300*prevProgress;return time},complete:function(element,prevProgress){var time=300*(1-prevProgress);return time},progress:function(element){element.css({display:"block"})}},reset:function(element){element.css({display:"",opacity:"","z-index":"","-webkit-transition":""})}},Chondric.allTransitions.slideleft={transitionIn:{start:function(element){$(element).css({display:"block"}),$(".body",element).css({"-webkit-transition":"none","-webkit-transform":"translate(100%, 0)"})},cancel:function(element,prevProgress){var time=300*prevProgress;return $(".body",element).css({"-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(100%, 0)"}),time},complete:function(element,prevProgress){var time=300*(1-prevProgress);return $(".body",element).css({"-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(0, 0)"}),time},progress:function(element,progress){$(element).css({display:"block"}),$(".body",element).css({"-webkit-transition":"none","-webkit-transform":"translate("+100*(1-progress)+"%, 0)"})}},transitionOut:{start:function(element){$(".body",element).css({"-webkit-transition":"none","-webkit-transform":"translate(0, 0)"})},cancel:function(element,prevProgress){var time=300*prevProgress;return $(".body",element).css({"-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(0, 0)"}),time},complete:function(element,prevProgress){var time=300*(1-prevProgress);return $(".body",element).css({"-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(-100%, 0)"}),time},progress:function(element,progress){$(element).css({display:"block"}),$(".body",element).css({"-webkit-transition":"none","-webkit-transform":"translate("+-100*progress+"%, 0)"})}},reset:function(element){element.css({display:""}),$(".body",element).css({"-webkit-transition":"","-webkit-transform":""})}},Chondric.allTransitions.slideright={transitionIn:{start:function(element){$(element).css({display:"block"}),$(".body",element).css({"-webkit-transition":"none","-webkit-transform":"translate(-100%, 0)"})},cancel:function(element,prevProgress){var time=300*prevProgress;return $(".body",element).css({"-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(-100%, 0)"}),time},complete:function(element,prevProgress){var time=300*(1-prevProgress);return $(".body",element).css({"-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(0, 0)"}),time},progress:function(element,progress){$(element).css({display:"block"}),$(".body",element).css({"-webkit-transition":"none","-webkit-transform":"translate("+-100*(1-progress)+"%, 0)"})}},transitionOut:{start:function(element){$(".body",element).css({"-webkit-transition":"none","-webkit-transform":"translate(0, 0)"})},cancel:function(element,prevProgress){var time=300*prevProgress;return $(".body",element).css({"-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(0, 0)"}),time},complete:function(element,prevProgress){var time=300*(1-prevProgress);return $(".body",element).css({"-webkit-transition":"-webkit-transform "+time+"ms ease-in-out","-webkit-transform":"translate(100%, 0)"}),time},progress:function(element,progress){$(element).css({display:"block"}),$(".body",element).css({"-webkit-transition":"none","-webkit-transform":"translate("+100*progress+"%, 0)"})}},reset:function(element){element.css({display:""}),$(".body",element).css({"-webkit-transition":"","-webkit-transform":""})}},Chondric.Syncable=function(options){var syncable=this,localIndex={},remoteIndex={},settings=syncable.settings={bulkSave:!1,saveAllToDb:function(){},saveToDb:function(){},removeFromDb:function(){},getRemoteId:function(remoteVersion){return remoteVersion.key},merge:function(wrapper,callback){wrapper.localId||(wrapper.localId=wrapper.remoteId),wrapper.hasLocalChanges||(wrapper.localVersion=wrapper.unmergedRemoteVersion),wrapper.unmergedRemoteVersion&&(wrapper.remoteVersion=wrapper.unmergedRemoteVersion,delete wrapper.unmergedRemoteVersion),wrapper.remoteVersion&&(wrapper.remoteId=settings.getRemoteId(wrapper.remoteVersion)),callback()},upload:function(wrapper,callback){callback()}};return $.extend(settings,options),syncable.updateIndex=function(wrapper){wrapper.remoteId&&(remoteIndex[wrapper.remoteId]=wrapper),wrapper.localId&&(localIndex[wrapper.localId]=wrapper)},syncable.getByRemoteId=function(id,callback){if(remoteIndex[id])return callback(remoteIndex[id]);var wrapper={remoteId:id};return callback(wrapper)},syncable.getByLocalId=function(id,callback){return callback(localIndex[id])},syncable.addNew=function(localId,localVersion){var wrapper={localId:localId,localVersion:localVersion,hasLocalChanges:!0,lastModified:(new Date).getTime()};return syncable.updateIndex(wrapper),wrapper},syncable.save=function(wrapper){syncable.updateIndex(wrapper),settings.bulkSave?settings.saveAllToDb(localIndex):settings.saveToDb(wrapper)},syncable.queueSave=function(wrapper,lastModified,isSystemUpdate){isSystemUpdate||(wrapper.hasLocalChanges=!0),wrapper.lastModified=lastModified||(new Date).getTime(),syncable.save(wrapper)},syncable.loadFromDbResults=function(wrappers){for(var i=0;i<wrappers.length;i++){var wrapper=wrappers[i];wrapper.remoteId&&remoteIndex[wrapper.remoteId]||wrapper.localId&&localIndex[wrapper.localId]||syncable.updateIndex(wrapper)}},syncable.loadSavedLocalIndex=function(data){localIndex=data;for(var li in data)syncable.updateIndex(data[li])},syncable.sync=function(wrapper,getRemoteVersion,mergeFunction,uploadFunction,callback){getRemoteVersion(wrapper.remoteId,function(newRemoteVersion){wrapper.unmergedRemoteVersion=newRemoteVersion,(mergeFunction||settings.merge)(wrapper,function(){syncable.updateIndex(wrapper),wrapper.hasLocalChanges?uploadFunction(wrapper,function(){(mergeFunction||settings.merge)(wrapper,function(){syncable.updateIndex(wrapper),syncable.queueSave(wrapper,wrapper.lastModified,!0),callback()})}):(syncable.queueSave(wrapper,wrapper.lastModified,!0),callback())})})},syncable.syncRemoteIndex=function(remoteObjects,callback){var keys=[];for(var rk in remoteObjects)keys.push(rk);var processItem=function(i){return i>=keys.length?callback():void syncable.getByRemoteId(keys[i],function(wrapper){syncable.sync(wrapper,function(remoteId,callback){callback(remoteObjects[keys[i]])},settings.merge,settings.upload,function(){processItem(i+1)})})};processItem(0)},syncable.syncRemoteArray=function(){},syncable.syncLocalChanges=function(callback){syncable.getItems(function(item){return item.hasLocalChanges},function(changedItems){var loopfn=function(i){return i>=changedItems.length?callback():changedItems[i].unmergedRemoteVersion?loopfn(i+1):void syncable.sync(changedItems[i],function(remoteId,callback){callback(changedItems[i].remoteVersion)},settings.merge,settings.upload,function(){loopfn(i+1)})};loopfn(0)})},syncable.uncache=function(filter,callback){var result=[];for(var li in localIndex){var item=localIndex[li];(!filter||filter(localIndex[li]))&&(delete localIndex[li],delete remoteIndex[item.remoteId],settings.bulkSave||settings.removeFromDb(item))}settings.bulkSave&&settings.saveAllToDb(localIndex),callback(result)},syncable.getItems=function(filter,callback){var result=[];for(var li in localIndex)(!filter||filter(localIndex[li]))&&result.push(localIndex[li]);callback(result)},this};
//# sourceMappingURL=chondric.min.map